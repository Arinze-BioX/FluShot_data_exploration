---
title: "Flushot train_test"
author: "Arinze Okafor"
date: "11/10/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Read in files
```{r}
library(readxl)
library(tidyverse)
library(xgboost)
library(caret)
library(plyr)
comp.case.df = read.csv("completeCases.csv", header = TRUE) %>% subset(., select=-X)
rfImp.df = read.csv("modelImputation_df.csv", header = TRUE) %>% subset(., select=-X)
unknown.case.df= read.csv("Unknown_for_all_categories.csv", header=TRUE) %>% subset(., select=-X)
mod.imp<- read.csv("modImputation_health_ins_as_category.csv", header = TRUE) %>% subset(., select=-X)

```

Trying random forest
```{r}
library(randomForest)
library(mlbench)
library(caret)
library(e1071)
library(doParallel)
library(rpart)
cores <- 4
registerDoParallel(cores = cores) #to enable parallel training

rpart_control = trainControl(
  method = "cv",
  number = 5)

rpart.rf_model = train(
  x=X.rf_train, y=factor(as.numeric(y.rf_train$h1n1_vaccine)),
  trControl = rpart_control,
  method = "rpart")

rpart.unkn_model = train(
  x=X.unkn_train, y=factor(as.numeric(y.unkn_train$h1n1_vaccine)),
  trControl = rpart_control,
  method = "rpart")
#rf.pred.df<- data.frame(X.rf_train, 'h1n1'=as.factor(y.rf_train))

rpart.comp_model = train(
  x=X.comp_train, y=factor(as.numeric(y.comp_train$h1n1_vaccine)),
  trControl = rpart_control,
  method = "rpart")

rpart.mode_model = train(
  x=X.mode_train, y=factor(as.numeric(y.mode_train$h1n1_vaccine)),
  trControl = rpart_control,
  method = "rpart")
```

predicting with rpart
```{r}
library(performanceEstimation)
rpart.rf.pred = predict(rpart.rf_model,X.rf_test)
rpart.mode.pred = predict(rpart.mode_model,X.mode_test)
rpart.comp.pred = predict(rpart.comp_model,X.comp_test)
rpart.unkn.pred = predict(rpart.unkn_model,X.unkn_test)

classificationMetrics(factor(as.numeric(y.rf_test$h1n1_vaccine)),rpart.rf.pred)
classificationMetrics(factor(as.numeric(y.comp_test$h1n1_vaccine)),rpart.comp.pred)
classificationMetrics(factor(as.numeric(y.unkn_test$h1n1_vaccine)),rpart.unkn.pred)
classificationMetrics(factor(as.numeric(y.mode_test$h1n1_vaccine)),rpart.mode.pred)


```

Get Important variables
```{r}
varImp(rpart.rf_model)
varImp(rpart.mode_model)
varImp(rpart.comp_model)
varImp(rpart.unkn_model)
```
Doing rpart again for seasonal
```{r}
rpart.rf_model = train(
  x=X.rf_train, y=factor(as.numeric(y.rf_train$seasonal_vaccine)),
  trControl = rpart_control,
  method = "rpart")

rpart.unkn_model = train(
  x=X.unkn_train, y=factor(as.numeric(y.unkn_train$seasonal_vaccine)),
  trControl = rpart_control,
  method = "rpart")
#rf.pred.df<- data.frame(X.rf_train, 'h1n1'=as.factor(y.rf_train))

rpart.comp_model = train(
  x=X.comp_train, y=factor(as.numeric(y.comp_train$seasonal_vaccine)),
  trControl = rpart_control,
  method = "rpart")

rpart.mode_model = train(
  x=X.mode_train, y=factor(as.numeric(y.mode_train$seasonal_vaccine)),
  trControl = rpart_control,
  method = "rpart")

library(performanceEstimation)
rpart.rf.pred = predict(rpart.rf_model,X.rf_test)
rpart.mode.pred = predict(rpart.mode_model,X.mode_test)
rpart.comp.pred = predict(rpart.comp_model,X.comp_test)
rpart.unkn.pred = predict(rpart.unkn_model,X.unkn_test)

a<-classificationMetrics(factor(as.numeric(y.rf_test$seasonal_vaccine)),rpart.rf.pred)
a[19]
classificationMetrics(factor(as.numeric(y.comp_test$seasonal_vaccine)),rpart.comp.pred)
classificationMetrics(factor(as.numeric(y.unkn_test$seasonal_vaccine)),rpart.unkn.pred)
classificationMetrics(factor(as.numeric(y.mode_test$seasonal_vaccine)),rpart.mode.pred)

varImp(rpart.rf_model)
varImp(rpart.mode_model)
varImp(rpart.comp_model)
varImp(rpart.unkn_model)
```

Trying one-hot encoding
```{r}
library(mltools)
comp.case.df<-one_hot(comp.case.df)
unknown.case.df<-one_hot(unknown.case.df)
rfImp.df<-one_hot(rfImp.df)
mod.imp<-one_hot(mod.imp)
```
##For H1N1 vaccine

Split data
```{r}
set.seed(123)
smp_size <- floor(0.75 * nrow(comp.case.df))
train_ind <- sample(seq_len(nrow(comp.case.df)), size = smp_size)

X.comp_train <- comp.case.df[train_ind, ] %>% subset(., select=-c(h1n1_vaccine, seasonal_vaccine))
X.comp_test <- comp.case.df[-train_ind, ] %>% subset(., select=-c(h1n1_vaccine))
y.comp_train = comp.case.df[train_ind,] %>% subset(., select=c(h1n1_vaccine, seasonal_vaccine))
y.comp_test= comp.case.df[-train_ind,] %>% subset(., select=c(h1n1_vaccine, seasonal_vaccine))

smp_size <- floor(0.75 * nrow(unknown.case.df))
train_ind <- sample(seq_len(nrow(unknown.case.df)), size = smp_size)

X.unkn_train <- unknown.case.df[train_ind, ] %>% subset(., select=-c(h1n1_vaccine, seasonal_vaccine))
X.unkn_test <- unknown.case.df[-train_ind, ] %>% subset(., select=-c(h1n1_vaccine))
y.unkn_train = unknown.case.df[train_ind,] %>% subset(., select=c(h1n1_vaccine, seasonal_vaccine))
y.unkn_test= unknown.case.df[-train_ind,] %>% subset(., select=c(h1n1_vaccine, seasonal_vaccine))

smp_size <- floor(0.75 * nrow(mod.imp))
train_ind <- sample(seq_len(nrow(mod.imp)), size = smp_size)

X.mode_train <- mod.imp[train_ind, ] %>% subset(., select=-c(h1n1_vaccine, seasonal_vaccine))
X.mode_test <- mod.imp[-train_ind, ] %>% subset(., select=-c(h1n1_vaccine))
y.mode_train = mod.imp[train_ind,] %>% subset(., select=c(h1n1_vaccine, seasonal_vaccine))
y.mode_test= mod.imp[-train_ind,] %>% subset(., select=c(h1n1_vaccine, seasonal_vaccine))


smp_size <- floor(0.75 * nrow(rfImp.df))
train_ind <- sample(seq_len(nrow(rfImp.df)), size = smp_size)

X.rf_train <- rfImp.df[train_ind, ] %>% subset(., select=-c(h1n1, seasonal))
X.rf_test <- rfImp.df[-train_ind, ] %>% subset(., select=-c(h1n1))
y.rf_train = rfImp.df[train_ind,] %>% transmute(h1n1_vaccine=h1n1, seasonal_vaccine=seasonal)
y.rf_test= rfImp.df[-train_ind,] %>% transmute(h1n1_vaccine=h1n1, seasonal_vaccine=seasonal)
```

#Under sampling
```{r}
library(unbalanced)
set.seed(123)
comp<-ubUnder(data.frame(X.comp_train, seasonal_vaccine=y.comp_train$seasonal_vaccine), y.comp_train$h1n1_vaccine, perc = 50, method = "percPos", w = NULL)
rf<-ubUnder(data.frame(X.rf_train, seasonal_vaccine=y.rf_train$seasonal_vaccine), y.rf_train$h1n1_vaccine, perc = 50, method = "percPos", w = NULL)
mo.de<-ubUnder(data.frame(X.mode_train, seasonal_vaccine=y.mode_train$seasonal_vaccine), y.mode_train$h1n1_vaccine, perc = 50, method = "percPos", w = NULL)
unkn<-ubUnder(data.frame(X.unkn_train, seasonal_vaccine=y.unkn_train$seasonal_vaccine), y.unkn_train$h1n1_vaccine, perc = 50, method = "percPos", w = NULL)

X.rf_train.h1n1<-rf$X
y.rf_train.h1n1<-rf$Y
X.comp_train.h1n1<-comp$X
y.comp_train.h1n1<-comp$Y
X.mode_train.h1n1<-mo.de$X
y.mode_train.h1n1<-mo.de$Y
X.unkn_train.h1n1<-unkn$X
y.unkn_train.h1n1<-unkn$Y

names(X.rf_test)<-names(X.rf_train.h1n1)
names(X.comp_test)<-names(X.rf_train.h1n1)
names(X.unkn_test)<-names(X.unkn_train.h1n1)
names(X.mode_test)<-names(X.rf_train.h1n1)
```

Trying XGBoost
```{r}
library(xgboost)
library(ROCR)

set.seed(123) 
library(Matrix)
library(performanceEstimation)
#prediction for model-based imputation
rf.train.xg.h1n1 <- as(as.matrix(sapply(X.rf_train.h1n1, function(x) as.numeric(as.factor(x)))), "dgCMatrix")
rf.test.xg.h1n1 <- as(as.matrix(sapply(X.rf_test, function(x) as.numeric(as.factor(x)))), "dgCMatrix")
bstSparse <- xgboost(data=rf.train.xg.h1n1, label=as.numeric(y.rf_train.h1n1), max.depth = 2, eta = 1, nthread = 2, nrounds = 20, objective = "binary:logistic", verbose = 0)

xg.pred.rf <- predict(bstSparse, rf.test.xg.h1n1)
classificationMetrics(factor(as.numeric(y.rf_test$h1n1_vaccine)),as.numeric(xg.pred.rf>0.6))

#plotting ROC
#pred <- prediction(as.numeric(y.rf_test$h1n1_vaccine), as.numeric(xg.pred.rf>0.6), label.ordering = NULL)
#perf <- performance(pred, measure = "tpr", x.measure = "fpr")
#plot(perf, main="Receiver Operating Characteristic (ROC) Curve")
#segments(x0=0, y0=0, x1=1, y1=1, col="gray", lty=2)
#area <- 
#auc(factor(as.numeric(y.rf_test$h1n1_vaccine)),as.numeric(xg.pred.rf>0.6))
#area <- format(round(area, 4), nsmall = 4)
#text(x=0.8, y=0.1, labels = paste("AUC =", area))

#PREDICTION for the complete case scenario
comp.train.xg.h1n1 <- as(as.matrix(sapply(X.comp_train.h1n1, function(x) as.numeric(as.factor(x)))), "dgCMatrix")
comp.test.xg.h1n1 <- as(as.matrix(sapply(X.comp_test, function(x) as.numeric(as.factor(x)))), "dgCMatrix")
bstSparse <- xgboost(data=comp.train.xg.h1n1, label=as.numeric(y.comp_train.h1n1), max.depth = 2, eta = 1, nthread = 2, nrounds = 20, objective = "binary:logistic", verbose = 0)

xg.pred.comp <- predict(bstSparse, comp.test.xg.h1n1)
classificationMetrics(factor(as.numeric(y.comp_test$h1n1_vaccine)),as.numeric(xg.pred.comp>0.6))

#plotting ROC
#auc(factor(as.numeric(y.comp_test$h1n1_vaccine)),as.numeric(xg.pred.comp>0.6))

#prediction for missingness as factor scenario
unkn.train.xg.h1n1 <- as(as.matrix(sapply(X.unkn_train.h1n1, function(x) as.numeric(as.factor(x)))), "dgCMatrix")
unkn.test.xg.h1n1 <- as(as.matrix(sapply(X.unkn_test, function(x) as.numeric(as.factor(x)))), "dgCMatrix")
bstSparse <- xgboost(data=unkn.train.xg.h1n1, label=as.numeric(y.unkn_train.h1n1), max.depth = 2, eta = 1, nthread = 2, nrounds = 20, objective = "binary:logistic", verbose = 0)

xg.pred.unkn <- predict(bstSparse, unkn.test.xg.h1n1)
classificationMetrics(factor(as.numeric(y.unkn_test$h1n1_vaccine)),as.numeric(xg.pred.unkn>0.6))

#plotting ROC
#auc(factor(as.numeric(y.comp_test$h1n1_vaccine)),as.numeric(xg.pred.comp>0.6))


#predicting for mode imputation
mode.train.xg.h1n1 <- as(as.matrix(sapply(X.mode_train.h1n1, function(x) as.numeric(as.factor(x)))), "dgCMatrix")
mode.test.xg.h1n1 <- as(as.matrix(sapply(X.mode_test, function(x) as.numeric(as.factor(x)))), "dgCMatrix")
bstSparse <- xgboost(data=mode.train.xg.h1n1, label=as.numeric(y.mode_train.h1n1), max.depth = 2, eta = 1, nthread = 2, nrounds = 20, objective = "binary:logistic", verbose = 0)

xg.pred.mode <- predict(bstSparse, mode.test.xg.h1n1)
classificationMetrics(factor(as.numeric(y.mode_test$h1n1_vaccine)),as.numeric(xg.pred.mode>0.6))

#plotting ROC
#auc(factor(as.numeric(y.comp_test$h1n1_vaccine)),as.numeric(xg.pred.comp>0.6))

```


##For seasonal

Split data
```{r}
set.seed(123)
smp_size <- floor(0.75 * nrow(comp.case.df))
train_ind <- sample(seq_len(nrow(comp.case.df)), size = smp_size)

X.comp_train <- comp.case.df[train_ind, ] %>% subset(., select=-c(h1n1_vaccine, seasonal_vaccine))
X.comp_test <- comp.case.df[-train_ind, ] %>% subset(., select=-c(seasonal_vaccine))
y.comp_train = comp.case.df[train_ind,] %>% subset(., select=c(h1n1_vaccine, seasonal_vaccine))
y.comp_test= comp.case.df[-train_ind,] %>% subset(., select=c(h1n1_vaccine, seasonal_vaccine))

smp_size <- floor(0.75 * nrow(unknown.case.df))
train_ind <- sample(seq_len(nrow(unknown.case.df)), size = smp_size)

X.unkn_train <- unknown.case.df[train_ind, ] %>% subset(., select=-c(h1n1_vaccine, seasonal_vaccine))
X.unkn_test <- unknown.case.df[-train_ind, ] %>% subset(., select=-c(seasonal_vaccine))
y.unkn_train = unknown.case.df[train_ind,] %>% subset(., select=c(h1n1_vaccine, seasonal_vaccine))
y.unkn_test= unknown.case.df[-train_ind,] %>% subset(., select=c(h1n1_vaccine, seasonal_vaccine))

smp_size <- floor(0.75 * nrow(mod.imp))
train_ind <- sample(seq_len(nrow(mod.imp)), size = smp_size)

X.mode_train <- mod.imp[train_ind, ] %>% subset(., select=-c(h1n1_vaccine, seasonal_vaccine))
X.mode_test <- mod.imp[-train_ind, ] %>% subset(., select=-c(seasonal_vaccine))
y.mode_train = mod.imp[train_ind,] %>% subset(., select=c(h1n1_vaccine, seasonal_vaccine))
y.mode_test= mod.imp[-train_ind,] %>% subset(., select=c(h1n1_vaccine, seasonal_vaccine))


smp_size <- floor(0.75 * nrow(rfImp.df))
train_ind <- sample(seq_len(nrow(rfImp.df)), size = smp_size)

X.rf_train <- rfImp.df[train_ind, ] %>% subset(., select=-c(h1n1, seasonal))
X.rf_test <- rfImp.df[-train_ind, ] %>% subset(., select=-c(seasonal))
y.rf_train = rfImp.df[train_ind,] %>% transmute(h1n1_vaccine=h1n1, seasonal_vaccine=seasonal)
y.rf_test= rfImp.df[-train_ind,] %>% transmute(h1n1_vaccine=h1n1, seasonal_vaccine=seasonal)

library(unbalanced)
set.seed(123)
comp<-ubUnder(data.frame(X.comp_train, seasonal_vaccine=y.comp_train$h1n1_vaccine), y.comp_train$seasonal_vaccine==0, perc = 50, method = "percPos", w = NULL)
rf<-ubUnder(data.frame(X.rf_train, seasonal_vaccine=y.rf_train$h1n1_vaccine), y.rf_train$seasonal_vaccine, perc = 50, method = "percPos", w = NULL)
mo.de<-ubUnder(data.frame(X.mode_train, seasonal_vaccine=y.mode_train$h1n1_vaccine), y.mode_train$seasonal_vaccine, perc = 50, method = "percPos", w = NULL)
unkn<-ubUnder(data.frame(X.unkn_train, seasonal_vaccine=y.unkn_train$h1n1_vaccine), y.unkn_train$seasonal_vaccine, perc = 50, method = "percPos", w = NULL)

X.rf_train.seas<-rf$X
y.rf_train.seas<-rf$Y
X.comp_train.seas<-comp$X
y.comp_train.seas<-as.numeric(comp$Y==FALSE)
X.mode_train.seas<-mo.de$X
y.mode_train.seas<-mo.de$Y
X.unkn_train.seas<-unkn$X
y.unkn_train.seas<-unkn$Y

names(X.rf_test)<-names(X.rf_train.seas)
names(X.comp_test)<-names(X.rf_train.seas)
names(X.unkn_test)<-names(X.unkn_train.seas)
names(X.mode_test)<-names(X.rf_train.seas)
```

Trying XGBoost
```{r}
library(xgboost)
library(pROC)

set.seed(123) 
library("Matrix")
rf.train.xg.seas <- as(as.matrix(sapply(X.rf_train.seas, function(x) as.numeric(as.factor(x)))), "dgCMatrix")
rf.test.xg.seas <- as(as.matrix(sapply(X.rf_test, function(x) as.numeric(as.factor(x)))), "dgCMatrix")
bstSparse <- xgboost(data=rf.train.xg.seas, label=as.numeric(y.rf_train.seas), max.depth = 2, eta = 1, nthread = 2, nrounds = 10, objective = "binary:logistic")

xg.pred.rf <- predict(bstSparse, rf.test.xg.seas)
classificationMetrics(factor(as.numeric(y.rf_test$seasonal_vaccine)),as.numeric(xg.pred.rf>0.6))


comp.train.xg.seas <- as(as.matrix(sapply(X.comp_train.seas, function(x) as.numeric(as.factor(x)))), "dgCMatrix")
comp.test.xg.seas <- as(as.matrix(sapply(X.comp_test, function(x) as.numeric(as.factor(x)))), "dgCMatrix")
bstSparse <- xgboost(data=comp.train.xg.seas, label=as.numeric(y.comp_train.seas), max.depth = 2, eta = 1, nthread = 2, nrounds = 10, objective = "binary:logistic")

xg.pred.comp <- predict(bstSparse, comp.test.xg.seas)
classificationMetrics(factor(as.numeric(y.comp_test$seasonal_vaccine)),as.numeric(xg.pred.comp>0.6))

unkn.train.xg.seas <- as(as.matrix(sapply(X.unkn_train.seas, function(x) as.numeric(as.factor(x)))), "dgCMatrix")
unkn.test.xg.seas <- as(as.matrix(sapply(X.unkn_test, function(x) as.numeric(as.factor(x)))), "dgCMatrix")
bstSparse <- xgboost(data=unkn.train.xg.seas, label=as.numeric(y.unkn_train.seas), max.depth = 2, eta = 1, nthread = 2, nrounds = 10, objective = "binary:logistic")

xg.pred.unkn <- predict(bstSparse, unkn.test.xg.seas)
classificationMetrics(factor(as.numeric(y.unkn_test$seasonal_vaccine)),as.numeric(xg.pred.unkn>0.6))

mode.train.xg.seas <- as(as.matrix(sapply(X.mode_train.seas, function(x) as.numeric(as.factor(x)))), "dgCMatrix")
mode.test.xg.seas <- as(as.matrix(sapply(X.mode_test, function(x) as.numeric(as.factor(x)))), "dgCMatrix")
bstSparse <- xgboost(data=mode.train.xg.seas, label=as.numeric(y.mode_train.seas), max.depth = 2, eta = 1, nthread = 2, nrounds = 10, objective = "binary:logistic")

xg.pred.mode <- predict(bstSparse, mode.test.xg.seas)
classificationMetrics(factor(as.numeric(y.mode_test$seasonal_vaccine)),as.numeric(xg.pred.mode>0.6))

```

##Plot ROCs for XGBoost model
```{r}
predict_obj <- predict(models_b$h1n1, type='prob')
pred <- prediction(xg.pred.mode, b$h1n1_vaccine)
plot(performance(pred, "tpr", "fpr"))
title("ROC Curve - Method A - H1N1")
abline(0,1,lty = 2)
auc_ROCR <- performance(pred, measure = "auc")
auc_ROCR <- auc_ROCR@y.values[[1]]
auc_ROCR 



```

##Trying XGBoost of decision tree
Installing necessary packages
```{r}
library(xgboost)
set.seed(123) 
library(Matrix)
library(performanceEstimation)
bstSparse <- xgboost(data = train$data, label = train$label, max.depth = 2, eta = 1, nthread = 2, nrounds = 2, objective = "binary:logistic")


#prediction for model-based imputation
rf.train.xg.h1n1 <- as(as.matrix(sapply(X.rf_train.h1n1, function(x) as.numeric(as.factor(x)))), "dgCMatrix")
rf.test.xg.h1n1 <- as(as.matrix(sapply(X.rf_test, function(x) as.numeric(as.factor(x)))), "dgCMatrix")
bstSparse <- xgboost(data=rf.train.xg.h1n1, label=as.numeric(y.rf_train.h1n1), max.depth = 7, eta = 1, nthread = 2, nrounds = 5, objective = "binary:logistic", verbose = 0)

xg.pred.rf <- predict(bstSparse, rf.test.xg.h1n1)
classificationMetrics(factor(as.numeric(y.rf_test$h1n1_vaccine)),as.numeric(xg.pred.rf>0.5))

#plotting ROC
#pred <- prediction(as.numeric(y.rf_test$h1n1_vaccine), as.numeric(xg.pred.rf>0.6), label.ordering = NULL)
#perf <- performance(pred, measure = "tpr", x.measure = "fpr")
#plot(perf, main="Receiver Operating Characteristic (ROC) Curve")
#segments(x0=0, y0=0, x1=1, y1=1, col="gray", lty=2)
#area <- 
#auc(factor(as.numeric(y.rf_test$h1n1_vaccine)),as.numeric(xg.pred.rf>0.6))
#area <- format(round(area, 4), nsmall = 4)
#text(x=0.8, y=0.1, labels = paste("AUC =", area))

#PREDICTION for the complete case scenario
comp.train.xg.h1n1 <- as(as.matrix(sapply(X.comp_train.h1n1, function(x) as.numeric(as.factor(x)))), "dgCMatrix")
comp.test.xg.h1n1 <- as(as.matrix(sapply(X.comp_test, function(x) as.numeric(as.factor(x)))), "dgCMatrix")
bstSparse <- xgboost(data=comp.train.xg.h1n1, label=as.numeric(y.comp_train.h1n1), max.depth = 2, eta = 1, nthread = 2, nrounds = 20, objective = "binary:logistic", verbose = 0)

xg.pred.comp <- predict(bstSparse, comp.test.xg.h1n1)
classificationMetrics(factor(as.numeric(y.comp_test$h1n1_vaccine)),as.numeric(xg.pred.comp>0.6))

#plotting ROC
#auc(factor(as.numeric(y.comp_test$h1n1_vaccine)),as.numeric(xg.pred.comp>0.6))

#prediction for missingness as factor scenario
unkn.train.xg.h1n1 <- as(as.matrix(sapply(X.unkn_train.h1n1, function(x) as.numeric(as.factor(x)))), "dgCMatrix")
unkn.test.xg.h1n1 <- as(as.matrix(sapply(X.unkn_test, function(x) as.numeric(as.factor(x)))), "dgCMatrix")
bstSparse <- xgboost(data=unkn.train.xg.h1n1, label=as.numeric(y.unkn_train.h1n1), max.depth = 2, eta = 1, nthread = 2, nrounds = 20, objective = "binary:logistic", verbose = 0)

xg.pred.unkn <- predict(bstSparse, unkn.test.xg.h1n1)
classificationMetrics(factor(as.numeric(y.unkn_test$h1n1_vaccine)),as.numeric(xg.pred.unkn>0.6))

#plotting ROC
#auc(factor(as.numeric(y.comp_test$h1n1_vaccine)),as.numeric(xg.pred.comp>0.6))


#predicting for mode imputation
mode.train.xg.h1n1 <- as(as.matrix(sapply(X.mode_train.h1n1, function(x) as.numeric(as.factor(x)))), "dgCMatrix")
mode.test.xg.h1n1 <- as(as.matrix(sapply(X.mode_test, function(x) as.numeric(as.factor(x)))), "dgCMatrix")
bstSparse <- xgboost(data=mode.train.xg.h1n1, label=as.numeric(y.mode_train.h1n1), max.depth = 2, eta = 1, nthread = 2, nrounds = 20, objective = "binary:logistic", verbose = 0)

xg.pred.mode <- predict(bstSparse, mode.test.xg.h1n1)
classificationMetrics(factor(as.numeric(y.mode_test$h1n1_vaccine)),as.numeric(xg.pred.mode>0.6))

#plotting ROC
#auc(factor(as.numeric(y.comp_test$h1n1_vaccine)),as.numeric(xg.pred.comp>0.6))
```


## Read in the Data

```{r}
set.seed(123)
a <- as.data.frame(read.csv("HI_factor_compcase_rest.csv", header = TRUE, stringsAsFactors = TRUE))
b <- as.data.frame(read.csv("modelImputation_df.csv", header = TRUE, stringsAsFactors = TRUE))
b <- b %>% rename(h1n1_vaccine = h1n1, seasonal_vaccine = seasonal)
c <- as.data.frame(read.csv("modImputation_health_ins_as_category.csv", header = TRUE, stringsAsFactors = TRUE))
d <- as.data.frame(read.csv("Unknown_for_all_categories.csv", header = TRUE, stringsAsFactors = TRUE))
e <- as.data.frame(read.csv("completeCases.csv", header = TRUE, stringsAsFactors = TRUE))
```

b=rf
c=mode
d=unkn
e=comp

## Load libraries

```{r}
library(corrplot)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(rpart)
library(mgcv)
library(ROCR)
```

## Build the Tree

Function definition:
```{r}
build_tree <- function(x) {
  vac_com_h1n1 <- subset(x, select = -c(seasonal_vaccine))
  vac_com_seas <- subset(x, select = -c(h1n1_vaccine))
  
  tree_obj <- rpart(data = vac_com_h1n1, formula = h1n1_vaccine ~ ., method = "class", minsplit = 10, cp = 0.0002)
  min_cp_h1n1 <- tree_obj$cptable[which.min(tree_obj$cptable[,"xerror"]),"CP"]
  tree_obj <- rpart(data = vac_com_h1n1, formula = h1n1_vaccine ~ ., method = "class", minsplit = 10, cp = min_cp_h1n1)
  
  plot(tree_obj)
  title("Decision Tree H1N1")
  summary(tree_obj)
  text(tree_obj)
  plotcp(tree_obj)
  printcp(tree_obj)
  rsq.rpart(tree_obj)
  title("X-relative Error vs. #Splits")
  
  tree_obj2 <- rpart(data = vac_com_seas, formula = seasonal_vaccine ~ ., method = "class", minsplit = 10, cp = 0.0002)
  min_cp_seas <- tree_obj2$cptable[which.min(tree_obj2$cptable[,"xerror"]),"CP"]
  tree_obj2 <- rpart(data = vac_com_seas, formula = seasonal_vaccine ~ ., method = "class", minsplit = 10, cp = min_cp_seas)
  
  tree_obj2$variable.importance
  
  plot(tree_obj2)
  title("Decision Tree Seasonal")
  summary(tree_obj2)
  text(tree_obj2)
  plotcp(tree_obj2)
  printcp(tree_obj2)
  rsq.rpart(tree_obj2)
  title("X-relative Error vs. #Splits")
  
  
  
  return(list("h1n1" = tree_obj, "seas" = tree_obj2))
}
```

Tree_a:
```{r}
models_a <- build_tree(a)
```

Tree_a ROC H1N1:
```{r}
predict_obj <- predict(models_a$h1n1, type='prob')
pred <- prediction(predict_obj[,2], a$h1n1_vaccine)
plot(performance(pred, "tpr", "fpr"))
title("ROC Curve - Method A - H1N1")
abline(0,1,lty = 2)
auc_ROCR <- performance(pred, measure = "auc")
auc_ROCR <- auc_ROCR@y.values[[1]]
auc_ROCR 
```

Tree_a ROC seasonal:
```{r}
predict_obj2 <- predict(models_a$seas, type='prob')
pred2 <- prediction(predict_obj2[,2], a$seasonal_vaccine)
plot(performance(pred2, "tpr", "fpr"))
title("ROC Curve - Method A - Seasonal")
abline(0,1,lty = 2)
auc_ROCR <- performance(pred2, measure = "auc")
auc_ROCR <- auc_ROCR@y.values[[1]]
auc_ROCR
```


Tree_b:
```{r}
models_b <- build_tree(b)
```

Tree_b ROC H1N1:
```{r}
predict_obj <- predict(models_b$h1n1, type='prob')
pred <- prediction(predict_obj[,2], b$h1n1_vaccine)
plot(performance(pred, "tpr", "fpr"))
title("ROC Curve - Method A - H1N1")
abline(0,1,lty = 2)
auc_ROCR <- performance(pred, measure = "auc")
auc_ROCR <- auc_ROCR@y.values[[1]]
auc_ROCR 
```


Tree_b ROC seasonal:
```{r}
predict_obj2 <- predict(models_b$seas, type='prob')
pred2 <- prediction(predict_obj2[,2], b$seasonal_vaccine)
plot(performance(pred2, "tpr", "fpr"))
title("ROC Curve - Method A - Seasonal")
abline(0,1,lty = 2)
auc_ROCR <- performance(pred2, measure = "auc")
auc_ROCR <- auc_ROCR@y.values[[1]]
auc_ROCR
```

Tree_c:
```{r}
models_c <- build_tree(c)
```

Tree_c ROC H1N1:
```{r}
predict_obj <- predict(models_c$h1n1, type='prob')
pred <- prediction(predict_obj[,2], c$h1n1_vaccine)
plot(performance(pred, "tpr", "fpr"))
title("ROC Curve - Method A - H1N1")
abline(0,1,lty = 2)
auc_ROCR <- performance(pred, measure = "auc")
auc_ROCR <- auc_ROCR@y.values[[1]]
auc_ROCR 
```


Tree_c ROC seasonal:
```{r}
predict_obj2 <- predict(models_c$seas, type='prob')
pred2 <- prediction(predict_obj2[,2], c$seasonal_vaccine)
plot(performance(pred2, "tpr", "fpr"))
title("ROC Curve - Method A - Seasonal")
abline(0,1,lty = 2)
auc_ROCR <- performance(pred2, measure = "auc")
auc_ROCR <- auc_ROCR@y.values[[1]]
auc_ROCR
```

Tree_d:
```{r}
models_d <- build_tree(d)
```

Tree_d ROC H1N1:
```{r}
predict_obj <- predict(models_d$h1n1, type='prob')
pred <- prediction(predict_obj[,2], d$h1n1_vaccine)
plot(performance(pred, "tpr", "fpr"))
title("ROC Curve - Method A - H1N1")
abline(0,1,lty = 2)
auc_ROCR <- performance(pred, measure = "auc")
auc_ROCR <- auc_ROCR@y.values[[1]]
auc_ROCR 
```


Tree_d ROC seasonal:
```{r}
predict_obj2 <- predict(models_d$seas, type='prob')
pred2 <- prediction(predict_obj2[,2], d$seasonal_vaccine)
plot(performance(pred2, "tpr", "fpr"))
title("ROC Curve - Method A - Seasonal")
abline(0,1,lty = 2)
auc_ROCR <- performance(pred2, measure = "auc")
auc_ROCR <- auc_ROCR@y.values[[1]]
auc_ROCR
```

Tree_e:
```{r}
models_e <- build_tree(e)
```

Tree_e ROC H1N1:
```{r}
predict_obj <- predict(models_e$h1n1, type='prob')
pred <- prediction(predict_obj[,2], e$h1n1_vaccine)
plot(performance(pred, "tpr", "fpr"))
title("ROC Curve - Method A - H1N1")
abline(0,1,lty = 2)
auc_ROCR <- performance(pred, measure = "auc")
auc_ROCR <- auc_ROCR@y.values[[1]]
auc_ROCR 
```


Tree_e ROC seasonal:
```{r}
predict_obj2 <- predict(models_e$seas, type='prob')
pred2 <- prediction(predict_obj2[,2], e$seasonal_vaccine)
plot(performance(pred2, "tpr", "fpr"))
title("ROC Curve - Method A - Seasonal")
abline(0,1,lty = 2)
auc_ROCR <- performance(pred2, measure = "auc")
auc_ROCR <- auc_ROCR@y.values[[1]]
auc_ROCR
```