---
title: "Exploratory_Analysis_Nick"
author: "Nicholas Garside"
date: "9/22/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Libraries:
```{r message = false}
library(corrplot)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(rpart)
library(mgcv)
```

# Exploratory Analysis


```{r}
data <- read.csv("training_set_features.csv", header = TRUE, stringsAsFactors = TRUE)
vac_df <- data.frame(data)

data_lab <- read.csv("training_set_labels.csv", header = TRUE)
vac_df_lab <- data.frame(data_lab)
```

Merge into one dataframe:
```{r}
vac_df$h1n1_vaccine <- as.numeric(vac_df_lab$h1n1_vaccine)
vac_df$seasonal_vaccine <- as.numeric(vac_df_lab$seasonal_vaccine)
```

Set data types:
```{r}
transform(vac_df, respondent_id = as.factor(respondent_id),
          h1n1_concern = as.integer(h1n1_concern),
          h1n1_knowledge = as.integer(h1n1_knowledge),
          behavioral_antiviral_meds = as.logical(behavioral_antiviral_meds),
          behavioral_avoidance = as.logical(behavioral_avoidance),
          behavioral_face_mask = as.logical(behavioral_face_mask),
          behavioral_wash_hands = as.logical(behavioral_wash_hands),
          behavioral_large_gatherings = as.logical(behavioral_large_gatherings),
          behavioral_outside_home = as.logical(behavioral_outside_home),
          behavioral_touch_face = as.logical(behavioral_touch_face),
          doctor_recc_h1n1 = as.logical(doctor_recc_h1n1),
          doctor_recc_seasonal = as.logical(doctor_recc_seasonal),
          chronic_med_condition = as.logical(chronic_med_condition),
          child_under_6_months = as.logical(child_under_6_months),
          health_worker = as.logical(health_worker),
          health_insurance = as.factor(health_insurance),
          opinion_h1n1_vacc_effective = as.integer(opinion_h1n1_vacc_effective),
          opinion_h1n1_risk = as.integer(opinion_h1n1_risk),
          opinion_h1n1_sick_from_vacc = as.integer(opinion_h1n1_sick_from_vacc),
          opinion_seas_vacc_effective = as.integer(opinion_seas_vacc_effective),
          opinion_seas_risk = as.integer(opinion_seas_risk),
          opinion_seas_sick_from_vacc = as.integer(opinion_seas_sick_from_vacc),
          age_group = as.factor(age_group),
          education = as.factor(education),
          race = as.factor(race),
          sex = as.factor(sex),
          income_poverty = as.factor(income_poverty),
          marital_status = as.factor(marital_status),
          rent_or_own = as.factor(rent_or_own),
          employment_status = as.factor(employment_status),
          hhs_geo_region = as.factor(hhs_geo_region),
          census_msa = as.factor(census_msa),
          household_adults = as.integer(household_adults),
          household_children = as.integer(household_children),
          employment_industry = as.factor(employment_industry),
          employment_occupation = as.factor(employment_occupation))
```


Generate Correlation Plot:
```{r}
c <- cor(vac_df[, sapply(vac_df, is.numeric)],
    use = "complete.obs", method = "pearson")
corrplot(c, tl.cex = 1, type = "upper")
```

For H1N1 vaccination, highly correlted variables include:
doctor_recc_h1n1
opinion_h1n1_vacc_effective
opinion_h1n1_vacc_risk
opinion_seas_vacc_risk
seasonal_vaccine (another output label)

For seasonal flu vaccination, highly correlated variables include:
doctor_recc_seasonal
opinion_seas_vacc_effective
opinion_h1n1_vacc_risk
opinion_seas_vacc_risk
h1n1_vaccine (another output label)

Other interesting trends:
1) High correlations between h1n1 and seas groups of opinion risk, opinion effective, and opinion sick from vacc
2) Slightly negative correlations for household_adults and household_children with seasonal_vaccine


## Summary

```{r}
vac_df %>% summary()
```

High-level demographics:
1) ~46.6% of all observations got the flu shot
2) ~21.3% of all observations got the h1n1 shot
3) 2/5 were male, 3/5 were female
4) Most were white
5) Tons of missing data for Employment Industry, Employment Occupation, and Health Insurance
6) ~82% wash hands, while only ~7% wear a face mask
7) ~5% said yes for antiviral meds
8) 26707 total observations
9) ~11% were healthcare workers
10) Most people ~80% think the vaccines are effective
11) Most people ~88% had health insurace
12) 0.5 children per household average (seems low)
13) About half and half on married vs. unmarried

## Grouped by Factors

```{r}
by_poverty <- vac_df %>% group_by(income_poverty)
by_poverty %>% summarise(seasonal = mean(seasonal_vaccine), h1n1 = mean(h1n1_vaccine))

by_age_group <- vac_df %>% group_by(age_group)
by_age_group %>% summarise(seasonal = mean(seasonal_vaccine), h1n1 = mean(h1n1_vaccine))

by_education <- vac_df %>% group_by(education)
by_education %>% summarise(seasonal = mean(seasonal_vaccine), h1n1 = mean(h1n1_vaccine))

by_health_worker <- vac_df %>% group_by(health_worker)
by_health_worker %>% summarise(seasonal = mean(seasonal_vaccine), h1n1 = mean(h1n1_vaccine))

by_opinion_seas_vacc_effective <- vac_df %>% group_by(opinion_seas_vacc_effective)
by_opinion_seas_vacc_effective %>% summarise(seasonal = mean(seasonal_vaccine), h1n1 = mean(h1n1_vaccine))

by_marital <- vac_df %>% group_by(marital_status)
by_marital %>% summarise(seasonal = mean(seasonal_vaccine), h1n1 = mean(h1n1_vaccine))

by_antiviral <- vac_df %>% group_by(behavioral_antiviral_meds)
by_antiviral %>% summarise(seasonal = mean(seasonal_vaccine), h1n1 = mean(h1n1_vaccine))

by_chronic_condition <- vac_df %>% group_by(chronic_med_condition)
by_chronic_condition %>% summarise(seasonal = mean(seasonal_vaccine), h1n1 = mean(h1n1_vaccine))

by_sex <- vac_df %>% group_by(sex)
by_sex %>% summarise(seasonal = mean(seasonal_vaccine), h1n1 = mean(h1n1_vaccine))

by_hhs <- vac_df %>% group_by(hhs_geo_region)
by_hhs %>% summarise(seasonal = mean(seasonal_vaccine), h1n1 = mean(h1n1_vaccine))

by_rent <- vac_df %>% group_by(rent_or_own)
by_rent %>% summarise(seasonal = mean(seasonal_vaccine), h1n1 = mean(h1n1_vaccine))

by_employment_occupation <- vac_df %>% group_by(employment_occupation)
by_employment_occupation %>% summarise(seasonal = mean(seasonal_vaccine), h1n1 = mean(h1n1_vaccine))

by_census <- vac_df %>% group_by(census_msa)
by_census %>% summarise(seasonal = mean(seasonal_vaccine), h1n1 = mean(h1n1_vaccine))

by_seasonal_vaccination <- vac_df %>% group_by(seasonal_vaccine)
by_seasonal_vaccination %>% summarise(seasonal = mean(seasonal_vaccine), h1n1 = mean(h1n1_vaccine))
```

Interesting Trends:
1) Increasing rate of vaccination as wealth status increases (both seasonal and h1n1)
2) Increasing rate of seasonal flu vaccination as age increases (no trend for h1n1)
3) Increasing rate of vaccination as education levels increase (both seasonal and h1n1)
4) Nearly 20% higher rate of vaccination if healthcare worker (both seasonal and h1n1)
5) ~70% vaccination compared to ~15% for favorable versus unfavorable opinions of vaccine effectiveness
6) Slightly higher (~4%) rate of vaccination if married
7) Significantly higher rate of vaccination if behavioral_antiviral_meds data is missing (otherwise similar rates)
8) ~10-20% higher rate of vaccination if person has chronic med condition.
9) Females ~8% higher rate of seasonal flu vaccination, but no difference for h1n1
10) No difference among all the hhs_geo_region categories
11) Significantly higher rate (~50% compared to ~37%) if you own a house rather than rent.
12) Ranges of vaccinates rates from 35-85% (seasonal), 14-62% (h1n1) depending on occupation
13) No difference between census_msa catagories
14) Around 37% of people who DO get the seasonal flu vaccine get the h1n1 vaccine as well.
15) Around 6% of people who DON'T get the seasonal flu vaccine get the h1n1 vaccine as well.


Filling in Missingness for Employment Information:
```{r}
vac_df$employment_occupation = as.character(vac_df$employment_occupation)
vac_df$employment_status = as.character(vac_df$employment_status)
vac_df$employment_industry = as.character(vac_df$employment_industry)
vac_df[vac_df$employment_status%in%c("Not in Labor Force","Unemployed")&vac_df$employment_occupation=="",c("employment_occupation", "employment_industry")] <- "Unemployed"
vac_df$employment_occupation = as.factor(vac_df$employment_occupation)
vac_df$employment_status = as.factor(vac_df$employment_status)
vac_df$employment_industry = as.factor(vac_df$employment_industry)
vac_df$h1n1_vaccine <- as.factor(vac_df$h1n1_vaccine)
vac_df$seasonal_vaccine <- as.factor(vac_df$seasonal_vaccine)

```

Now seeing the summary:
```{r}
summary(vac_df)
```

## Missingness as Factor for Health Insurance

```{r}
vac_df[vac_df$health_insurance%in%c("", NA),c("health_insurance")] <- "Unknown"
vac_df
```

```{r}
vac_df$health_insurance <- as.factor(vac_df$health_insurance)
vac_df
```

```{r}
summary(vac_df)
```

Complete cases after health_insurance factorization:
```{r}
vac_complete <- vac_df[complete.cases(vac_df), ]
summary(vac_complete)
```

Create "Unknown" factor within education, income_poverty, marital_status, rent_or_own, employment_status:
```{r}
vac_complete[vac_complete$education%in%c("", " ",NA),c("education")] <- "Unknown"
vac_complete[vac_complete$income_poverty%in%c("", " ", NA),c("income_poverty")] <- "Unknown"
vac_complete[vac_complete$marital_status%in%c("", " ", NA),c("marital_status")] <- "Unknown"
vac_complete[vac_complete$rent_or_own%in%c("", " ", NA),c("rent_or_own")] <- "Unknown"
vac_complete[vac_complete$employment_status%in%c("", " ", NA),c("employment_status")] <- "Unknown"

vac_complete$education <- as.factor(vac_complete$education)
vac_complete$income_poverty <- as.factor(vac_complete$income_poverty)
vac_complete$marital_status <- as.factor(vac_complete$marital_status)
vac_complete$rent_or_own <- as.factor(vac_complete$rent_or_own)
vac_complete$employment_status <- as.factor(vac_complete$employment_status)

summary(vac_complete)
```

```{r}
vac_complete$h1n1_vaccine <- as.factor(vac_complete$h1n1_vaccine)
vac_complete$seasonal_vaccine <- as.factor(vac_complete$seasonal_vaccine)
head(vac_complete, 30)
```

## Decision Tree

Create subsets that contain only one output:
```{r}
vac_com_h1n1 <- subset(vac_complete, select = -c(seasonal_vaccine))
vac_com_seas <- subset(vac_complete, select = -c(h1n1_vaccine))
```

Build the h1n1 tree:
```{r}
tree_obj <- rpart(data = vac_com_h1n1, formula = h1n1_vaccine ~ .)
```

Plot results:
```{r}
plot(tree_obj)
summary(tree_obj)
text(tree_obj)

plotcp(tree_obj)
printcp(tree_obj)

rsq.rpart(tree_obj)
title("R-Squared vs. #Features")
```
Build the seas tree:
```{r}
tree_obj2 <- rpart(data = vac_com_seas, formula = seasonal_vaccine ~ .)
```

Plot the results:
```{r}
plot(tree_obj2)
text(tree_obj2)

plotcp(tree_obj2)
printcp(tree_obj2)

rsq.rpart(tree_obj2)
title("R-Squared vs. #Features")
```

Now to find importance



## LASSO for feature selection:

## GAM

```{r}

```

## Deletion of health insurance with mode/mean imputed

```{r}
vac_deleted_hi <- subset(vac_df, select = -c(health_insurance))
```

Now to impute using mean of each column:
```{r}

```

## Unknown for all missing cells:
```{r}
vac_unknown <- vac_df
vac_unknown[is.na(vac_unknown)] <- "Unknown"

summary(vac_unknown)
head(vac_unknown, 10)
```


## Writing post-imputated dataframes to .csv:
```{r}
write.csv(vac_complete, file = "HI_factor_compcase_rest.csv")
write.csv(vac_unknown, file = "Unknown_for_all_categories.csv")
```


# End of Exploratory Analysis